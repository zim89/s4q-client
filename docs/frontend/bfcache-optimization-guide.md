# Back/Forward Cache (bfcache) Optimization Guide

## üéØ –¶–µ–ª—å

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Back/Forward Cache –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

## üîç –ß—Ç–æ —Ç–∞–∫–æ–µ Back/Forward Cache?

**Back/Forward Cache (bfcache)** - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –±—Ä–∞—É–∑–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞–∑–∞–¥" –∏–ª–∏ "–í–ø–µ—Ä–µ–¥", —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ –∫—ç—à–∞.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚ö° **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–∞ 0ms
- üîÑ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - —Ñ–æ—Ä–º—ã, —Å–∫—Ä–æ–ª–ª –ø–æ–∑–∏—Ü–∏—è, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- üì± **–≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞** - –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã
- üéØ **–õ—É—á—à–∏–π UX** - –ø–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç bfcache

### 1. Cache-Control: no-store

```
Pages with cache-control:no-store header cannot enter back/forward cache.
```

**–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∑–∞–ø—Ä–µ—â–∞—é—â–∏–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:**

- –£–±—Ä–∞—Ç—å `no-store` –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `public, max-age=300` –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞-—Ç–µ–≥–∏ –≤ HTML

### 2. WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```
Pages with WebSocket cannot enter back/forward cache.
Back/forward cache is disabled because WebSocket has been used.
```

**–ü—Ä–∏—á–∏–Ω–∞:** WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å bfcache.

**–†–µ—à–µ–Ω–∏–µ:**

- –ó–∞–∫—Ä—ã–≤–∞—Ç—å WebSocket –ø—Ä–∏ `pagehide`
- –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ `pageshow`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Server-Sent Events –≤–º–µ—Å—Ç–æ WebSocket –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

### 3. –î—Ä—É–≥–∏–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã:

- `unload` —Å–æ–±—ã—Ç–∏—è
- `beforeunload` —Å–æ–±—ã—Ç–∏—è
- IndexedDB —Å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
- BroadcastChannel API
- SharedWorker

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ú–µ—Ç–∞-—Ç–µ–≥–∏ –≤ Layout

```html
<!-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Back/Forward Cache -->
<meta name="back-forward-cache" content="enabled" />
<meta name="cache-control" content="public, max-age=300" />
```

### 2. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å bfcache

```typescript
// src/shared/utils/bfcache.utils.ts
export const setupBFCacheHandlers = () => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ bfcache
  window.addEventListener('pageshow', event => {
    if (event.persisted) {
      console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ bfcache')
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }
  })

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ bfcache
  window.addEventListener('pagehide', event => {
    if (event.persisted) {
      console.log('üíæ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ bfcache')
    }
  })
}
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ AppProviders

```typescript
// src/app/providers/index.tsx
export const AppProviders = ({ children }: { children: React.ReactNode }) => {
  useEffect(() => {
    setupBFCacheHandlers()
  }, [])

  return (
    <QueryProvider>
      {/* ... */}
    </QueryProvider>
  )
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ bfcache

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

```typescript
import { getBFCacheInfo, supportsBFCache } from '@/shared/utils'

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
const isSupported = supportsBFCache()

// –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
const info = getBFCacheInfo()
console.log(info)
```

### 2. DevTools

–í Chrome DevTools:

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Application** tab
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Back/forward cache**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### 3. Lighthouse

Lighthouse –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å bfcache –≤ —Ä–∞–∑–¥–µ–ª–µ **Opportunities**:

- "Page prevented back/forward cache restoration"
- –°–ø–∏—Å–æ–∫ –ø—Ä–∏—á–∏–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ò–∑–±–µ–≥–∞–π—Ç–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤

```typescript
// ‚ùå –ü–ª–æ—Ö–æ - –±–ª–æ–∫–∏—Ä—É–µ—Ç bfcache
window.addEventListener('beforeunload', () => {
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
})

// ‚úÖ –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ pagehide
window.addEventListener('pagehide', event => {
  if (!event.persisted) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
  }
})
```

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ bfcache
window.addEventListener('pageshow', event => {
  if (event.persisted) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    refreshUserData()
    updateTimestamp()
  }
})
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
const isMobile = /Android|iPhone|iPad/.test(navigator.userAgent)
const supportsBFCache = 'onpageshow' in window

if (isMobile && supportsBFCache) {
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –ù–∞–∂–º–∏—Ç–µ "–ù–∞–∑–∞–¥"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

### 2. DevTools —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Application** ‚Üí **Back/forward cache**
3. –ù–∞–∂–º–∏—Ç–µ **Test back/forward cache**
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 3. Lighthouse —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
npm run lighthouse http://localhost:3000/warsaw/beauty-1
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª **Opportunities** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–±–ª–µ–º —Å bfcache.

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ bfcache:

- ‚ö° **–ù–∞–≤–∏–≥–∞—Ü–∏—è "–ù–∞–∑–∞–¥/–í–ø–µ—Ä–µ–¥"** - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- üì± **–ú–æ–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- üéØ **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX** - –ø–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- üìä **–õ—É—á—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏** - —É–ª—É—á—à–µ–Ω–∏–µ Core Web Vitals

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

1. **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ Cache-Control
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DevTools –Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã

2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `pagehide` –≤–º–µ—Å—Ç–æ `beforeunload`
   - –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage/sessionStorage
   - –û–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ `pageshow`

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π**
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
   - –û–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ refresh token –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
